server {
        listen 80;
        #listen [::]:80 default_server;
        return 301 https://$host$request_uri;
}

server {
        listen 443 ssl;
        ssl_certificate /etc/nginx/certs/box4security.cert.pem;
        ssl_certificate_key /etc/nginx/certs/box4security.key.pem;
        auth_basic "4sConsult";
        auth_basic_user_file /etc/nginx/htpasswd;
        server_name Box4Security;
#	rewrite ^/ https://$host$request_uri/security-plattform;
        index kibana.php;
	root /var/www/kibana/html/;
	location = /favicon.ico {
 	   alias /var/www/html/res/favicon.ico;
	}
        location / {
                try_files $uri $uri/ /kibana.php?$args;
                auth_basic off;
                #include snippets/fastcgi-php.conf;
        	 fastcgi_split_path_info ^(.+?\.php)(/.*)$;
		fastcgi_index kibana.php; 
	       fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;
# regex to split $uri to $fastcgi_script_name and $fastcgi_path
	fastcgi_split_path_info ^(.+?\.php)(/.*)$;

	# Check that the PHP script exists before passing it
	#try_files $fastcgi_script_name =404;

	# Bypass the fact that try_files resets $fastcgi_path_info
	# see: http://trac.nginx.org/nginx/ticket/321
	set $path_info $fastcgi_path_info;
	fastcgi_param PATH_INFO $path_info;

	#fastcgi_index index.php;
	include fastcgi.conf;

         }

	location /res/ {
               	root /var/www/html/;
                auth_basic off;
	#	return 301 /security-plattform
     }
        location /gsa/ {
                return 301 https://$host:9392;
        }
        location /administration.php {
                root /var/www/kibana/html/;
                auth_basic off;
        #       return 301 /security-plattform
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;

     }

	location /semantic/ {
		root /var/www/;
		auth_basic off;
	}

	location /bpf_filter.php {
		root /var/www/kibana/html/;
		auth_basic off;
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;	
	}
        location /kibana/ {
                auth_basic off;
		#proxy_set_header Authorization "";
                proxy_pass http://localhost:5601/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;	       
 	}
#	location /phpmyadmin {
#		root /var/www/html;
#                include snippets/fastcgi-php.conf;
#                fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;
#		
#		auth_basic off;
#		}

	location * {
                return 403;
        }
}
