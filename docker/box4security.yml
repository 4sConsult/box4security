version: '2.3'

services:
  baseimage:
    build: baseimage/.
    container_name: baseimage
    image: "docker-registry.am-gmbh.de/it-security/b4s/baseimage:dev"
  elasticsearch:
    build: elasticsearch/.
    container_name: elasticsearch
    restart: always
    ports:
     - 9200:9200
    image: "docker-registry.am-gmbh.de/it-security/b4s/elasticsearch:dev"
    volumes:
     - data:/data
  kibana:
    build: kibana/.
    container_name: kibana
    restart: always
    ports:
     - 5601:5601
    image: "docker-registry.am-gmbh.de/it-security/b4s/kibana:dev"
    depends_on:
      elasticsearch:
        condition: service_healthy
    stop_signal: SIGKILL
  logstash:
    build: logstash/.
    container_name: logstash
    restart: always
    depends_on:
      elasticsearch:
        condition: service_healthy
      db:
        condition: service_healthy
    env_file:
     - /etc/default/logstash
    ports:
      - 9600:9600
      - 5044:5044
      - 5046:5046
    image: "docker-registry.am-gmbh.de/it-security/b4s/logstash:dev"
    volumes:
      - varlib_logstash:/var/lib/logstash/
      - etcbox4s_logstash:/etc/logstash/conf.d/general/
      - varlib_box4s:/var/lib/box4s/
  filebeat:
    build: filebeat/.
    container_name: filebeat
    depends_on:
      logstash:
        condition: service_healthy
    image: "docker-registry.am-gmbh.de/it-security/b4s/filebeat:dev"
    volumes:
      
  web:
    container_name: web
    image: "docker-registry.am-gmbh.de/it-security/b4s/web:dev"
    build:
      context: ./web
      dockerfile: Dockerfile.prod
    command: gunicorn --bind 0.0.0.0:5000 main:app
    volumes:
       - static_volume:/home/app/web/source/static
       - /var/log/box4s/:/var/log/box4s/
       - varlib_box4s/:/var/lib/box4s/
    expose:
      - 5000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/_health"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Add dockerhost IP to /etc/hosts in container for ssh
    extra_hosts:
      - "dockerhost:${INT_IP}"
    env_file:
      - ./.env.prod.web
      - ../VERSION
    depends_on:
      - db
  db:
    container_name: db
    image: "docker-registry.am-gmbh.de/it-security/b4s/db:dev"
    build:
      context: ./db
    volumes:
      - varlib_postgresql/:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    env_file:
      - ./.env.prod.db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  nginx:
    container_name: nginx
    image: "docker-registry.am-gmbh.de/it-security/b4s/nginx:dev"
    build:
      context: ./nginx
    ports:
      - 80:80
      - 443:443
    volumes:
      - static_volume:/home/app/web/source/static
      # certs (placed in host /etc/ folder by install script)
      - /etc/nginx/certs:/etc/nginx/certs
    depends_on:
      - web
      - kibana

volumes:
  # to persist data beyond container's life
  static_volume:
  data:
    external: true
  varlib_postgresql:
    external: true
  varlib_box4s:
    external: true
  varlib_logstash:
    external: true
  etcbox4s_logstash:
    external: true
